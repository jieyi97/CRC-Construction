# directory: (base) jieyidi@gnosiophobie:/project/NeuralNet/CRC/ChIP-seq>

# --- STAR mapping ---

# quality control
## for single fq file
fastqc ./fastq/HM/H3K4me3_HI-21.fq.gz -o ./fastqc/HM/

## qc in a loop
ls ./fastq/HM/*.gz | while read id; do (fastqc $id -o ./fastqc/HM/); done
multiqc ./fastqc/HM/ -o ./multiqc/HM/

# mapping
## loop: without nohup &, setting from the paper, define the file name
star_version="/project/ngsvin/bin/mapping/STAR/STAR_2.6.1d/bin/Linux_x86_64/STAR"
ls ./fastq/HM/*.gz | while read id;
do
	file=${id##*/}  # select the part after the last slash
	# e.g. fastq/HM/H3K4me1_HI-21.fq.gz -> H3K4me1_HI-21.fq.gz
	sample=${file%%.*}  # select the part before the first dot
	# e.g. H3K4me1_HI-21.fq.gz -> H3K4me1_HI-21
	${star_version} --runThreadN 10 \
	--genomeDir /project/ngsvin/MappingIndices/STAR/hg19 \
	--readFilesIn ${id} \
	--readFilesCommand zcat \
	--alignEndsType EndToEnd \
	--alignIntronMax 1 \
	--alignSJDBoverhangMin 999 \
	--outTmpDir /scratch/local2/jieyidi/STAR \
	--outSAMtype BAM Unsorted \
	--outStd BAM_Unsorted \
	--outSAMmultNmax 1 \
	--outFilterMultimapNmax 1 \
	--outFilterMismatchNmax 1 \
	--outFileNamePrefix ./mapping/STAR/unsorted_bam_logs/${sample}_ \
	> ./mapping/STAR/unsorted_bam/${sample}.bam
done

## for single file: without nohup &, setting from the paper, define the file name
${star_version} --runThreadN 10 \
--genomeDir /project/ngsvin/MappingIndices/STAR/hg19 \
--readFilesIn ./fastq/HM/H3K27ac_HI-45.fq.gz \
--readFilesCommand zcat \
--alignEndsType EndToEnd \
--alignIntronMax 1 \
--alignSJDBoverhangMin 999 \
--outTmpDir /scratch/local2/jieyidi/STAR \
--outSAMtype BAM Unsorted \
--outStd BAM_Unsorted \
--outSAMmultNmax 1 \
--outFilterMultimapNmax 1 \
--outFilterMismatchNmax 1 \
--outFileNamePrefix ./mapping/STAR_logs_test/H3K27ac_HI-45_ \
> ./mapping/STAR_test/H3K27ac_HI-45.bam


${star_version} --runThreadN 10 \
--genomeDir /project/ngsvin/MappingIndices/STAR/hg19 \
--readFilesIn ./fastq/HM/H3K27ac_HI-45.fq.gz \
--readFilesCommand zcat \
--alignEndsType EndToEnd \
--alignIntronMax 1 \
--alignSJDBoverhangMin 999 \
--outTmpDir /scratch/local2/jieyidi/STAR \
--outSAMtype BAM Unsorted \
--outStd BAM_Unsorted \
--outSAMmultNmax 1 \
--outFilterMultimapNmax 1 \
--outFilterMismatchNmax 1 \
--outFileNamePrefix ./mapping/STAR_logs_test/H3K27ac_HI-45_ \
> ./mapping/STAR_test/H3K27ac_HI-45.bam





# check MAPQ 
samtools view ./mapping/STAR/rmdup_bam/H3K27ac_HI-32.bam | cut -f 5 | sort -n | uniq -c
## 255 = unique mapping
## 3 = mapping to 2 locations in the target
## 2 =  mapping to 3 locations
## 1 = mapping to 4-9 locations
## 0 = mapping to 10 or more locations

# sort
ls ./mapping/STAR/unsorted_bam/*.bam | while read id;
do
	sample=$(basename $id)
	# sample=$(basename $id ".bam")
	samtools sort -@ 10 $id -o ./mapping/STAR/sorted_bam/$sample
done

# build bam index
ls ./mapping/STAR/sorted_bam/*.bam | while read id;
do
	samtools index -@ 10 $id
done

# remove duplicates
tmp_dir="/scratch/local2/jieyidi/"
ls ./mapping/STAR/sorted_bam/*.bam | while read id;
do
	sambamba markdup -r -t 10 --overflow-list-size 600000 --tmpdir $tmp_dir $id ./mapping/STAR/rmdup_bam/$(basename $id)
done

# 

# bam file qc
ls -tr ./mapping/STAR/*.bam | while read id; do (nohup samtools flagstat -@)




# --- bowtie2 ---
# https://hbctraining.github.io/Intro-to-ChIPseq/lessons/03_align_and_filtering.html
cd /project/NeuralNet/CRC/ChIP-seq/mapping/bowtie2
# get the reference genome
wget http://hgdownload.cse.ucsc.edu/goldenpath/hg19/bigZips/latest/hg19.fa.gz

# unzip the file
gunzip -c hg19.fa.gz > hg19.fa

# remove the zipped file
rm hg19.fa.gz

# build bowtie2 index
## using 10 threads and it takes 25 min or so
bowtie2-build hg19.fa hg19

# mapping
index="/project/NeuralNet/CRC/ChIP-seq/mapping/bowtie2/hg19"
bowtie2 -q -p 10 -x $index/hg19 -U ../../fastq/HM/H3K27ac_HI-32.fq.gz -N 1 -S ./H3K27ac_HI-32.sam 2>bowtie2.log

## -q: fastq files
## -p 10: number of processors
## -x /path/to/index/
## -U /path/to/fastq/file for single-end reads
## -N 1: allow maximum 1 mismatch
## -S /path/to/output/sam/file

# sam2bam
samtools view -@ 10 -hbS H3K27ac_HI-32.sam > H3K27ac_HI-32.unsorted.bam
rm H3K27ac_HI-32.sam

# sort
sambamba sort -t 10 -o H3K27ac_HI-32.sorted.bam H3K27ac_HI-32.unsorted.bam

## -t 10: number of threads
## -o /path/to/output/file

# unique mapping & remove duplicates
sambamba view -t 10 -h -f bam -F "[XS] == null and not unmapped and not duplicate" H3K27ac_HI-32.sorted.bam > H3K27ac_HI-32.bam


# --- CRUPwrapper.pl ---
cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam
CRUPwrapper="/project/ngsvin/bin/CRUP/CRUPwrapper.pl"

# CRUP: sample 32
$CRUPwrapper -threads 10 \
-bam "H3K*32.bam" \
-pattern "(HI.\d+)" \
-label islets \
-out /project/NeuralNet/CRC/ChIP-seq/crup \
-tmp /project/NeuralNet/CRC/ChIP-seq/crup/CRUPtmp \
-test

# merge samples by modifications
cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam
samtools merge -@ 10 -o H3K4me1.merged.bam H3K4me1*.bam
samtools merge -@ 10 -o H3K4me3.merged.bam H3K4me3*.bam
samtools merge -@ 10 -o H3K27ac.merged.bam H3K27*.bam

samtools merge -@ 10 -o H3K4me1.ex32.merged.bam H3K4me1_HI-21.bam H3K4me1_HI-25.bam
samtools merge -@ 10 -o H3K4me3.ex32.merged.bam H3K4me3_HI-21.bam H3K4me3_HI-25.bam


# build index
samtools index -@ 10 H3K4me1.merged.bam
samtools index -@ 10 H3K4me3.merged.bam
samtools index -@ 10 H3K27ac.merged.bam

samtools index -@ 10 H3K4me1.ex32.merged.bam
samtools index -@ 10 H3K4me3.ex32.merged.bam

# CRUP: merged samples
$CRUPwrapper -threads 10 \
-bam "*.merged.bam" \
-pattern "(merged)" \
-label islets \
-out /project/NeuralNet/CRC/ChIP-seq/crup \
-tmp /project/NeuralNet/CRC/ChIP-seq/crup/CRUPtmp \
-test
## error resolved after I built indices for merged bam files.


# --- bamCompare ---
conda activate genetics
cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam

multiBamSummary bins -p 10 --smartLabels \
--bamfiles *merged.bam *32.bam \
-o readCounts.npz \
--outRawCounts readCounts.tab

plotCorrelation -in readCounts.npz \
--corMethod spearman \
--skipZeros \
--plotTitle "Spearman Correlation of Read Counts" \
--whatToPlot heatmap \
--colorMap RdYlBu \
--plotNumbers \
-o SpearmanCorr_readCounts.pdf \
--outFileCorMatrix SpearmanCorr_readCounts.tab

plotCorrelation -in readCounts.npz \
--corMethod pearson \
--skipZeros \
--plotTitle "pearson Correlation of Read Counts" \
--whatToPlot heatmap \
--colorMap RdYlBu \
--plotNumbers \
-o PearsonCorr_readCounts.pdf \
--outFileCorMatrix PearsonCorr_readCounts.tab


# comparison without sample 32
multiBamSummary bins -p 10 --smartLabels \
--bamfiles *ex32*.bam *45.bam *32.bam \
-o ../bamCompare/readCounts.ex32.npz \
--outRawCounts ../bamCompare/readCounts.ex32.tab

cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/bamCompare
plotCorrelation -in readCounts.ex32.npz \
--corMethod spearman \
--skipZeros \
--plotTitle "Spearman Correlation of Read Counts (excluding sample 32)" \
--whatToPlot heatmap \
--colorMap RdYlBu \
--plotNumbers \
-o SpearmanCorr_readCounts.ex32.pdf \
--outFileCorMatrix SpearmanCorr_readCounts.ex32.tab

# comparison before merge
multiBamSummary bins -p 10 --smartLabels \
--bamfiles H3K27ac_*.bam H3K4me1_*.bam H3K4me3_*.bam \
-o ../bamCompare/readCounts.b4.npz \
--outRawCounts ../bamCompare/readCounts.b4.tab

cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/bamCompare
plotCorrelation -in readCounts.b4.npz \
--corMethod spearman \
--skipZeros \
--plotTitle "Spearman Correlation of Read Counts (before merging)" \
--whatToPlot heatmap \
--colorMap RdYlBu \
--plotNumbers \
-o SpearmanCorr_readCounts.b4.pdf \
--outFileCorMatrix SpearmanCorr_readCounts.b4.tab

## using RPKM bam2bw
cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam
bamCoverage -p 10 \
-b H3K27ac_HI-32.bam \
-o H3K27ac_HI-32.bw \
--binSize 25 \
--normalizeUsing RPKM \
--centerReads \
--smoothLength 50 2> ../logs/H3K27ac_HI-32_bamCoverage.log


ls *HI*.bam | tail -7 | while read id;
do
	sample=$(basename $id ".bam")
	bamCoverage -p 10 -b $id -o ${sample}.bw --binSize 25 --normalizeUsing RPKM --centerReads --smoothLength 50 2> ../logs/${sample}_bamCoverage.log
done



# --- bedTools ---
# bedTools computing overlapping regions
## preparation
(base) jieyidi@funfair:/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982> cut -f 1 islet_enhancer_hubs.bed | cut -f 1 -d ":" | cut -d "r" -f 2 > a.bed  # chr number
cut -f 1 islet_enhancer_hubs.bed | cut -f 2 -d ":" | cut -d "-" -f 1 | paste -d "\t" a.bed - > b.bed  # start position
cut -f 1 islet_enhancer_hubs.bed | cut -f 2 -d ":" | cut -d "-" -f 2 | paste -d "\t" b.bed - > c.bed  # end position
sed "1d" c.bed > islet.enhHubs.bed


## enhancer location predicted by CRUP
crupEnh="/project/NeuralNet/CRC/crup/islets.merged.CRUP.clusterEnh.bed"  # 11341
# crupEnh="/project/NeuralNet/CRC/crup/islets.HI-32.CRUP.clusterEnh.bed"  # 11422

## enhancer hubs from Ferrer 2019
hubs="/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet.enhHubs.bed"
# hubs="/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet_enhancer_hubs.bed"  # 1318

## super enhancer from Ferrer 2019
sed "s/chr//" islet_super_enhancers.bed > islet.SE.bed
SE="/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet.se.bed"  # 770
# SE="/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet_super_enhancers.bed"  # 770

## enhancer clusters from Ferrer 2014 (source data to supplementary Fig. 5 / 6)
sed -i "s/chr//" islet.enhClusters.bed
clusters="/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet.enhClusters.bed"  # 3677
# sed -i "s/chr//" islet.enhClusters.TF.bed
# clusters="/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet.enhClusters.TF.bed"  # 1813

## islets.merged.CRUP.clusterEnh.bed
## crup (11,341) vs enhancer hubs (1,318)
bedtools intersect -a $crupEnh -b $hubs -wa -u | wc -l  # 5989
bedtools intersect -a $hubs -b $crupEnh -wa -u | wc -l  # 1314
# >= 50% overlap
bedtools intersect -a $crupEnh -b $hubs -wa -u -f 0.5 | wc -l  # 5824
bedtools intersect -a $hubs -b $crupEnh -wa -u -f 0.5 | wc -l  # 42

## crup (11,341) vs super enhancers (770)
bedtools intersect -a $crupEnh -b $SE -wa -u | wc -l  # 836
bedtools intersect -a $SE -b $crupEnh -wa -u | wc -l  # 770
# >= 50% overlap
bedtools intersect -a $crupEnh -b $SE -wa -u -f 0.5 | wc -l  # 688
bedtools intersect -a $SE -b $crupEnh -wa -u -f 0.5 | wc -l  # 688

## crup (11,341) vs enhancer clusters (3,677)
bedtools intersect -a $crupEnh -b $clusters -wa -u | wc -l  # 1258
bedtools intersect -a $clusters -b $crupEnh -wa -u | wc -l  # 1091
# >= 50% overlap
bedtools intersect -a $crupEnh -b $clusters -wa -u -f 0.5 | wc -l  # 785
bedtools intersect -a $clusters -b $crupEnh -wa -u -f 0.5 | wc -l  # 324

## crup (11,341) vs enhancer clusters bound by islet TF (1,813)
bedtools intersect -a $crupEnh -b $clusters -wa -u | wc -l  # 697
bedtools intersect -a $clusters -b $crupEnh -wa -u | wc -l  # 579
# >= 50% overlap
bedtools intersect -a $crupEnh -b $clusters -wa -u -f 0.5 | wc -l  # 464
bedtools intersect -a $clusters -b $crupEnh -wa -u -f 0.5 | wc -l  # 150







## sed examples
cd /project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982
$ cat f.bed
chr1	10	20
chr1	22	28
chr1	30	40
chr2	15	22
$ sed "s/chr//" f.bed  # delete chr
1	10	20
1	22	28
1	30	40
2	15	22
$ sed "s/chr//" f.bed | sed "s/\([0-9XY]\)/chr\1/"  # add chr [0-9XY] => \w
chr1	10	20
chr1	22	28
chr1	30	40
chr2	15	22
# sed "s/.*[0-9XY]/chr/"  # match the whole string of "chr1", "chrX"

$ sed -n "6,10p" file_name  # show 6-10 rows



# bedtools fisher
## sort chromsize file
wget --timestamping 'ftp://hgdownload.soe.ucsc.edu/goldenPath/hg19/bigZips/hg19.chrom.sizes' -O hg19.chrom.sizes
sed -i "s/chr//" hg19.chrom.sizes  # 1
sed -i '25,90d' hg19.chrom.sizes  # delete lines 25-90 
sed -i '26,$d' hg19.chrom.sizes  # only chr1-22, X, Y, M are left
sort -k 1,1 hg19.chrom.sizes > hg19.chrom.sorted.sizes  # 2
rm hg19.chrom.sizes  # rm file 1
mv hg19.chrom.sorted.sizes hg19.chrom.sizes  # rename file 2
sed -i "s/M/MT/" hg19.chrom.sizes  # rename chrM to chrMT

## sort crup file
sort -k1,1 -k2,2n $crupEnh > islets.merged.CRUP.clusterEnh.sorted.bed
crupEnh="/project/NeuralNet/CRC/crup/islets.merged.CRUP.clusterEnh.sorted.bed"
# sort -k1,1 -k2,2n islets.HI-32.CRUP.clusterEnh.bed > islets.HI-32.CRUP.clusterEnh.sorted.bed
# crupEnh="/project/NeuralNet/CRC/crup/islets.HI-32.CRUP.clusterEnh.sorted.bed"

## sort hubs file  # hubs file is already sorted
## sort SE file  # SE is already sorted
## sort clusters file
sort -k1,1 -k2,2n $clusters > /project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet.enhClusters.sorted.bed
clusters='/project/NeuralNet/CRC/Papers/EnhancerHub_PubMed31253982/islet.enhClusters.sorted.bed'

bedtools fisher -a $crupEnh -b $hubs -g hg19.chrom.sizes
bedtools fisher -a $crupEnh -b $SE -g hg19.chrom.sizes
bedtools fisher -a $crupEnh -b $clusters -g hg19.chrom.sizes



# -------------------- 09.05 --------------------
# 1. running ROSE using example data
# -----------------------------------------------
ssh gnosiophobie
cd /project/NeuralNet/CRC/ROSE/ROSE_package  # root directory must be the directory containing ROSE_main.py

# running script on the server
# need to modify ROSE_utils.py to specify samtools version, in line 632,
# otherwise, can't get the statistical summary of control bam. 

gff="/project/NeuralNet/CRC/ROSE/ROSE_DATA/data/HG18_MM1S_MED1_1000.gff"
bam="/project/NeuralNet/CRC/ROSE/ROSE_DATA/data/MM1S_MED1.hg18.bwt.sorted.bam"
outdir="/project/NeuralNet/CRC/ROSE/example_data"
control="/project/NeuralNet/CRC/ROSE/ROSE_DATA/data/MM1S_WCE.hg18.bwt.sorted.bam"
python2 ROSE_main.py -g HG18 -i $gff -r $bam -o $outdir -s 12500 -t 2500 -c $control  # this script uses python2

# or running script on clusters
# https://intranet.molgen.mpg.de/en/service/scientific-service/it/infos/cluster/
mxqsub --stdout="../example_data/example.log" \
	   --group-name="rose_example" \
	   --processors=10 \
	   --memory=50G \
	   --runtime=2d \
	   python2 ROSE_main.py \
	   		-g HG18 \
	   		-i ../ROSE_DATA/data/HG18_MM1S_MED1_1000.gff \
	   		-r ../ROSE_DATA/data/MM1S_MED1.hg18.bwt.sorted.bam \
	   		-c ../ROSE_DATA/data/MM1S_WCE.hg18.bwt.sorted.bam \
	   		-s 12500 \
	   		-t 2500 \
	   		-o ../example_data/
# check running status
mxqdump --group-id ...
# kill the job
mxqkill --group-id


# -------------------- 09.07 --------------------
# 1. running ROSE using example data
# 2. recapitulation of Meissner's paper
#    - 2.1 download raw data (fastq) > /project/NeuralNet/CRC/ChIP-seq/Meissner/
#    - 2.2 bowtie2 mapping + to bam
#    - 2.3 comparison between samples
#    - 2.4 MACS2
#    - (x) 2.5 promoter regions: tss +/- 2kb (09.19)
#    - 2.6 ROSE
#    - 2.7 CRCmapper (09.22)
#    - 2.8 debugging (09.29)
#    - 2.9 visualization (10.05)
# 3. CRUP -> ROSE -> CRCmapper
#	 - 3.1 ROSE
# -----------------------------------------------

# 2.1 download raw data (only DE, at present)
# https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE139817
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/

# download data
cat SRR_Acc_List.txt | while read id; 
do
	wget https://sra-pub-run-odp.s3.amazonaws.com/sra/$id/$id -O $id.fastq.gz
done

# rename file names
sed -n "2,7p" SRR_ChIP-seq_acc_list.txt | awk -F "\t" '{system("mv "$1".fastq.gz "$16".fastq.gz")}'

# rename .fastq.gz .man DE*  # .fastq.gz -> .man

# transform data into fastq file
ls DE* | tail -n 5 | while read id;
do


	fastq-dump --split-3 --gzip $id
done

# quality control
ls *.gz | while read id; do (fastqc $id -o ./qc/fastqc/); done
multiqc ./qc/fastqc/ -o ./qc/multiqc/

# 2.2 bowtie2 mapping
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/

# mapping

# for single file
index="/project/NeuralNet/CRC/ChIP-seq/mapping/bowtie2/hg19"
bowtie2 -q -p 10 -x $index/hg19 -1 DE_H3K27ac_rep1_run1_1.fastq.gz -2 DE_H3K27ac_rep1_run1_2.fastq.gz -S DE_H3K27ac_rep1_run1.sam 2>DE_H3K27ac_rep1_run1.log

# loop
index="/project/NeuralNet/CRC/ChIP-seq/mapping/bowtie2/hg19"
ls -v *_1.fastq.gz | while read id;
do
	name=${id%_*}
	bowtie2 -q -p 15 -x $index/hg19 -1 $id -2 ${name}_2.fastq.gz \
	-S ${name}.sam \
	> ${name}.log 2>&1
done

# sam2bam
ls *.sam | while read id;
do
	samtools view -@ 10 -hbS $id > ${id%.*}.unsorted.bam
done
rm *.sam

# sort
ls *.bam | while read id;
do
	sambamba sort -t 10 $id -o ${id%%.*}.bam
done
rm *.unsorted.bam

# 2.3 comparison between samples
conda activate genetics

multiBamSummary bins -p 10 --smartLabels \
--bamfiles *.bam \
-o readCounts.npz \
--outRawCounts readCounts.tab

plotCorrelation -in readCounts.npz \
--corMethod pearson \
--skipZeros \
--plotTitle "Pearson Correlation of Read Counts" \
--whatToPlot heatmap \
--colorMap RdYlBu \
--plotNumbers \
-o PearsonCorr_readCounts.pdf \
--outFileCorMatrix PearsonCorr_readCounts.tab

# merge
samtools merge -@ 10 *H3K27ac*.bam -o DE_H3K27ac.bam
samtools index -@ 10 DE_H3K27ac.bam

samtools merge -@ 10 *WCE*.bam -o DE_WCE.bam
samtools index -@ 10 DE_WCE.bam

samtools flagstat

rm *run[0-9].*
rm *.tab *.npz


# 2.4 call peaks by MACS2
## https://github.com/crazyhottommy/ChIP-seq-analysis/blob/master/part1.3_MACS2_peak_calling_details.mds
# 1. --narrow-q 0.01
# 2. --narrow-q 0.01, --broad-q 0.01
# 3. --narrow-q 0.01, --broad-q 0.05
# 4. --narrow-q 0.05, --broad-q 0.05
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
time macs2 callpeak -t DE_H3K27ac.bam -c DE_WCE.bam --name DE --bdg -q 0.05 --broad --broad-cutoff 0.05 --outdir ./macs2_DE_narrow.05_broad.05 2>./macs2_DE_narrow.05_broad.05/DE.log  # 14m14.386s
# macs2 callpeak -t DE_H3K27ac.bam -c DE_WCE.bam --name DE --bdg -q 0.01 --broad --broad-cutoff 0.01 --outdir ./macs2_broad 2>./macs2_broad/logs/DE.macs2.log
## time real	13m48.112s
## callpeak analysis
mkdir macs2_DE_analysis
time macs2 callpeak -t DE_H3K27ac.bam -c DE_WCE.bam --name DE -q --broad --broad-cutoof --outdir ./macs2_DE_analysis 2>./macs2_DE_analysis/DE_analysis.log


# 2.5 promoter regions: tss +/- 2kb
# ref: https://www.biostars.org/p/250091/
# bedops: https://bedops.readthedocs.io/en/latest/content/reference/set-operations/bedops.html#everything-u-everything
# hg19_refseq_NMNR: original hg19_refseq.ucsc
# hg19_refseq_NM: original hg19_refseq.ucsc only with NM_*
# hg19_refseq: archive refseq downloaded from https://hgdownload.soe.ucsc.edu/goldenPath/archive/hg19/ncbiRefSeq/105.20201022/hg19.ncbiRefSeq.txt.gz
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
wget -qO- http://hgdownload.cse.ucsc.edu/goldenPath/hg19/database/refGene.txt.gz | gunzip -c - | awk 'BEGIN{ OFS="\t" } { print $3,$5,$6,$13,$10,$4 }' - | sort-bed - > hg19.refGene.bed
# $3-chr; $5-txStart; $6-txEnd; $13-name2; $10-exonStart; $4-strand

awk '($6 == "+") { print $0 }' hg19.refGene.bed | awk 'BEGIN{ OFS="\t"; a=2000; b=2000 } ($2 > a) { print $1,($2-a),($2+b),$4,$5,$6}' > hg19.refGene.tss.for.padded.bed

awk '($6 == "-") { print $0 }' hg19.refGene.bed | awk 'BEGIN{ OFS="\t"; a=2000; b=2000 } ($3 > b) { print $1,($3-b),($3+a),$4,$5,$6}' > hg19.refGene.tss.rev.padded.bed

bedops --everything hg19.refGene.tss.for.padded.bed hg19.refGene.tss.rev.padded.bed > hg19.refGene.tss.padded.bed  # concatenate for&rev

fetchChromSizes hg19 | awk '{ print $1"\t0\t"$2 }' | sort-bed - > hg19.bounds.bed  # chromSize
bedops --element-of 100% hg19.refGene.tss.padded.bed hg19.bounds.bed | sort-bed - > hg19.refGene.tss.2kb.bed

rm *padded*
rm hg19.bounds.bed hg19.refGene.bed

# awk 'BEGIN{ OFS="\t" } {NF=6}1' ./macs2/DE_peaks.narrowPeak | sort-bed - > ./macs2/DE_peaks.sorted.bed
awk 'BEGIN{ OFS="\t" } {NF=6}1' ./macs2_broad/DE_peaks.broadPeak | sort-bed - > ./macs2_broad/DE_peaks.sorted.bed

# wc -l ./macs2/DE_peaks.sorted.bed  # 20061
wc -l ./macs2_broad/DE_peaks.broadPeak  # 19118
wc -l hg19.refGene.tss.2kb.bed  # 81407

# bedops --not-element-of 1 ./macs2/DE_peaks.sorted.bed hg19.refGene.tss.2kb.bed > ./macs2/DE_peaks_notss.bed
# wc -l ./macs2/DE_peaks_notss.bed  # 8703
# rm ./macs2/DE_peaks.sorted.bed
bedops --not-element-of 1 ./macs2_broad/DE_peaks.sorted.bed hg19.refGene.tss.2kb.bed > ./macs2_broad/DE_peaks_notss.bed
wc -l ./macs2_broad/DE_peaks_notss.bed  # 8529
rm ./macs2_broad/DE_peaks.sorted.bed

# exclude overlaps in summit bed file
wc -l ./macs2/DE_summits.bed  # 20061
bedops --element-of 1 ./macs2/DE_summits.bed ./macs2/DE_peaks.bed > ./macs2/DE_summits_notss.bed
wc -l ./macs2/DE_summits_notss.bed  # 8703

# ncbiRefSeq
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
wget -qO- http://hgdownload.cse.ucsc.edu/goldenPath/hg19/database/ncbiRefSeq.txt.gz | gunzip -c - | awk 'BEGIN{ OFS="\t" } { print $3,$5,$6,$13,$4 }' - | sort-bed - > hg19.ncbiRefSeq.bed
# http://hgdownload.soe.ucsc.edu/goldenPath/archive/hg19/ncbiRefSeq/105.20190906/hg19.ncbiRefSeq.txt.gz
awk '($5 == "+") { print $0 }' hg19.ncbiRefSeq.bed | awk 'BEGIN{ OFS="\t"; a=2000; b=2000 } ($2 > a) { print $1,($2-a),($2+b),$4,$5}' > hg19.ncbiRefSeq.tss.for.padded.bed
awk '($5 == "-") { print $0 }' hg19.ncbiRefSeq.bed | awk 'BEGIN{ OFS="\t"; a=2000; b=2000 } ($3 > b) { print $1,($3-b),($3+a),$4,$5}' > hg19.ncbiRefSeq.tss.rev.padded.bed
rm hg19.ncbiRefSeq.bed
bedops --everything hg19.ncbiRefSeq.tss.for.padded.bed hg19.ncbiRefSeq.tss.rev.padded.bed | sort-bed - > hg19.ncbiRefSeq.tss.padded.bed  # concatenate for&rev
rm hg19.ncbiRefSeq.tss.for.padded.bed hg19.ncbiRefSeq.tss.rev.padded.bed
fetchChromSizes hg19 | awk '{ print $1"\t0\t"$2 }' | sort-bed - > hg19.bounds.bed  # chromSize
bedops --element-of 100% hg19.ncbiRefSeq.tss.padded.bed hg19.bounds.bed | sort-bed - > hg19.ncbiRefSeq.tss.2kb.bed
rm hg19.ncbiRefSeq.tss.padded.bed hg19.bounds.bed
awk 'BEGIN{ OFS="\t" } {NF=6}1' ./macs2_broad/DE_peaks.broadPeak | sort-bed - > ./macs2_broad/DE_peaks.sorted.bed

wc -l ./macs2_broad/DE_peaks.broadPeak  # 19118
wc -l hg19.ncbiRefSeq.tss.2kb.bed  # 86229
bedops --not-element-of 1 ./macs2_broad/DE_peaks.sorted.bed hg19.ncbiRefSeq.tss.2kb.bed | --element-of 100% ./macs2/DE_peaks_notss.bed - | wc -l  # 8531

# archive ncbiRefSeq
wget -qO- https://hgdownload.soe.ucsc.edu/goldenPath/archive/hg19/ncbiRefSeq/105.20201022/hg19.ncbiRefSeq.txt.gz | gunzip -c - | awk 'BEGIN{ FS=OFS="\t" } $2~/NM/{ print $0 }' > hg19_refseq.ucsc
# 59461
cut -f 2,13 annotation/hg19_refseq.ucsc | sort -u -t\t -k1,1 > TFlist_NMid_hg.txt
cd /project/NeuralNet/CRC/CRCmapper/hg19
ls * | while read chr; do echo ${chr%.*} >> ../CRCmapper_package/annotation/hg19.chrom;done
cd ../CRCmapper_package/annotation/
cat hg19.chrom | while read chr; do grep -w $chr hg19_refseq.ncbi >> new.txt; done

# built-in annoation
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
awk 'BEGIN{ OFS="\t" } NR>1 { print $3,$5,$6,$13,$4 }' ../../ROSE/ROSE_package/annotation/hg19_refseq.ucsc | sort-bed - > hg19_refseq.ucsc.bed
awk '($5 == "+") { print $0 }' hg19_refseq.ucsc.bed | awk 'BEGIN{ OFS="\t"; a=2000; b=2000 } ($2 > a) { print $1,($2-a),($2+b),$4,$5}' > hg19_refseq.tss.for.padded.bed
awk '($5 == "-") { print $0 }' hg19_refseq.ucsc.bed | awk 'BEGIN{ OFS="\t"; a=2000; b=2000 } ($3 > b) { print $1,($3-b),($3+a),$4,$5}' > hg19_refseq.tss.rev.padded.bed
rm hg19_refseq.ucsc.bed
bedops --everything hg19_refseq.tss.for.padded.bed hg19_refseq.tss.rev.padded.bed | sort-bed - > hg19_refseq.tss.padded.bed
rm hg19_refseq.tss.for.padded.bed hg19_refseq.tss.rev.padded.bed
fetchChromSizes hg19 | awk '{ print $1"\t0\t"$2 }' | sort-bed - > hg19.bounds.bed  # chromSize
bedops --element-of 100% hg19_refseq.tss.padded.bed hg19.bounds.bed | sort-bed - > hg19_refseq.tss.2kb.bed
rm hg19_refseq.tss.padded.bed hg19.bounds.bed
bedops --not-element-of 1 ./macs2_broad/DE_peaks.sorted.bed hg19_refseq.tss.2kb.bed | wc -l

bedtools subtract -a ./macs2_broad_0.05/DE_peaks.broadPeak -b hg19_refseq.tss.2kb.bed > ./macs2_broad_0.05/DE_peaks_notss.broadPeak

# 2.6 ROSE
# http://younglab.wi.mit.edu/super_enhancer_code.html
# https://bitbucket.org/young_computation/rose/src/master/
## a: MACS2.enhancers.gff
## b: H3K27ac.bam + *.bam.bai
## c: WCE.bam + *.bam.bai

# making .gff file
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/macs2_broad
## .bed file (6): chr 	start 	end 	name 	score 	strand
## .gff file (9): chr 	name 	None 	start 	end 	None 	strand 	None 	name2
# awk 'BEGIN{ FS=OFS="\t" } {print $1,$4,"\t"$2,$3,"\t"$6,"\t"$4}' DE_peaks_notss.bed > DE_peaks_notss.gff
awk 'BEGIN{ FS=OFS="\t" } {print $1,$4,"\t"$2,$3,"\t"$6,"\t"$4}' DE_peaks.broadPeak > DE_peaks.broadPeak.gff

ssh gnosiophobie
cd /project/NeuralNet/CRC/ROSE/ROSE_package  # root directory must be the directory containing ROSE_main.py
mkdir ../paper_data

# running script on the server
# need to modify ROSE_utils.py to specify samtools version, in line 632,
# otherwise, can't get the statistical summary of control bam. 
# (x) modify ROSE_bamToGFF.py in line 40 to halve the number of millionMappedReads (MMR)
# hg19_refseq_NMNR: original hg19_refseq.ucsc
# hg19_refseq_NM: original hg19_refseq.ucsc only with NM_*
# hg19_refseq.ncbi: archive refseq downloaded from https://hgdownload.soe.ucsc.edu/goldenPath/archive/hg19/ncbiRefSeq/105.20201022/hg19.ncbiRefSeq.txt.gz
# hg19_refseq.ucsc: archive refseq with cert


# 1. --narrow-q 0.01, removeTSS+/-2kb by UCSC refGene, exclTSS+/-2.5kb by ROSE
# 2. --narrow-q 0.01, --broad-q 0.01, removeTSS+/-2kb by UCSC refGene, exclTSS+/-2.5kb by ROSE
# 3. --narrow-q 0.01, --broad-q 0.01, exclTSS+/-2kb by ROSE
# 4. --narrow-q 0.01, --broad-q 0.05, exclTSS+/-2kb by ROSE
# 5. --narrow-q 0.05, --broad-q 0.05, incluTSS (i.e. -t 0)
# 6. --narrow-q 0.05, --broad-q 0.05, exclTSS+/-2kb by ROSE (NM)
# 7. --narrow-q 0.05, --broad-q 0.05, exclTSS+/-2kb by ROSE (NM ncbi.refSeq)

gff="/project/NeuralNet/CRC/ChIP-seq/Meissner/macs2_DE_narrow.05_broad.05/DE_peaks.broadPeak.gff"
bam="/project/NeuralNet/CRC/ChIP-seq/Meissner/DE_H3K27ac.bam"
control="/project/NeuralNet/CRC/ChIP-seq/Meissner/DE_WCE.bam"
outdir="/project/NeuralNet/CRC/ROSE/5.rose_DE_narrow.05_broad.05_incltss/"
base=$(basename $bam)
time python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 2000 -c $control > $outdir/${base%_*}.log &
## 75m37.768s
# time python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 2000 -c $control > $outdir/${base%_*}.log
## real	30m38.287s
## real	65m41.299s
mxqsub --group-name="rose_main" --processors=10 --memory=10G --runtime=5h --stdout="$outdir/${base%_*}.log" python2 ROSE_main.py -g HG19_NR -i $gff -r $bam -o $outdir -s 12500 -t 2000 -c $control &


# 2.7 CRCmapper
cd /project/NeuralNet/CRC/CRCmapper

# downloading genome fasta files
mkdir hg19
cd hg19
wget --timestamping 'ftp://hgdownload.cse.ucsc.edu/goldenPath/hg19/chromosomes/*'
rm *.txt
ls *.gz | while read id; do (gunzip $id); done

# CRCmapper.py modifications
## line 63: python -> python2
## line 333: fasta-get-markov -> /project/ngsvin/bin/Meme/meme-5.4.1/libexec/meme-5.4.1/fasta-get-markov
## line 337: fimo -> /project/ngsvin/bin/Meme/meme-5.4.1/bin/fimo

# hg19_refseq_NMNR: original hg19_refseq.ucsc
# hg19_refseq_NM: original hg19_refseq.ucsc only with NM_*
# hg19_refseq: archive refseq downloaded from https://hgdownload.soe.ucsc.edu/goldenPath/archive/hg19/ncbiRefSeq/105.20201022/hg19.ncbiRefSeq.txt.gz
# TFlist_NMid_hg_NMNR.txt: original TFlist
# TFlist_NMid_hg.txt: TFlist extracted from hg19_refseq

# run CRCmapper
cd /project/NeuralNet/CRC/CRCmapper/CRCmapper_package/
mkdir ../results_3
# 1. --narrow-q 0.01, removeTSS+/-2kb by UCSC refGene, exclTSS+/-2.5kb by ROSE
# 2. --narrow-q 0.01, --broad-q 0.01, removeTSS+/-2kb by UCSC refGene, exclTSS+/-2.5kb by ROSE
# 3. --narrow-q 0.01, --broad-q 0.01, exclTSS+/-2kb by ROSE
# 4. --narrow-q 0.01, --broad-q 0.05, exclTSS+/-2kb by ROSE
# 5. --narrow-q 0.05, --broad-q 0.05, incluTSS (i.e. -t 0)

enhTable="/project/NeuralNet/CRC/ROSE/7.rose_DE_narrow.05_broad.05_refSeq/DE_peaks_AllEnhancers.table.txt"
bam="/project/NeuralNet/CRC/ChIP-seq/Meissner/DE_H3K27ac.bam"
genome="../hg19/"
bed="/project/NeuralNet/CRC/ChIP-seq/Meissner/macs2_DE_narrow.05_broad.05/DE_peaks.broadPeak"
outdir="/project/NeuralNet/CRC/CRCmapper/5.crc_DE_narrow.05_broad.05/"
base=$(basename $bam)
time python2 CRCmapper.py -e $enhTable -b $bam -g HG19 -f $genome -s $bed -n DE -o $outdir > $outdir/${base%_*}.log &
## 83m41.680s
## real	81m55.766s

ls -l results* | grep '^-' | wc -l  # count number
ls results* | while read id; do (mv $id ./results/${id#results});done
mkdir ./results/motifs
ls ./results/*motifs.bed | while read id;
do
	name=$(basename $id)
	mv $id ./results/motifs/$name
done

# FIMO: ls -l /project/ngsvin/bin/Meme/meme-5.4.1/bin/
# motif: /project/ngsvin/TransFac/TFP_2021.3/dat


# 2.8 debugging
## a. check TF files in CRCmapper package  
### all TFs that are recognized as auto-regulatory TFs in the paper exist in the TF list in the package
## b. check every step in the pipeline
### hg19.refGene.tss.2kb.bed unsorted > peaks number changed
### !!! I didn't exclude the regions in summits.bed file that overlap with gene promoter-proximal regions
### divided MMR in ROSE_bamToGff.py by 2 -> exactly the same results, doesn't matter at all.
### broadPeaks, MACS2 --broad --broad-cutoff 0.01
### stupid mistake!!! input for CRCmapper (-s [SUBPEAKS]) is not the summit.bed!!! it should be the peaks.bed file
### tss
## b. check overlaps
## c. visualization of ChIP-seq data

# getting DE_SE.byH3K27ac.bed & DE_TE.byH3K27ac.bed
wget -qO- https://ftp.ncbi.nlm.nih.gov/geo/series/GSE140nnn/GSE140500/suppl/GSE140500%5FDE%5FSE%2EbyH3K27ac%2Ebed%2Egz | gunzip -c - > GSE140500_DE_SE.byH3K27ac.bed
wget -qO- https://ftp.ncbi.nlm.nih.gov/geo/series/GSE140nnn/GSE140500/suppl/GSE140500%5FDE%5FTE%2EbyH3K27ac%2Ebed%2Egz | gunzip -c - > GSE140500_DE_TE.byH3K27ac.bed
wget -qO- https://ftp.ncbi.nlm.nih.gov/geo/series/GSE140nnn/GSE140500/suppl/GSE140500%5FBeta%5FSE%2EbyH3K27ac%2Ebed%2Egz | gunzip -c - > GSE140500_Beta_SE.byH3K27ac.bed
wget -qO- https://ftp.ncbi.nlm.nih.gov/geo/series/GSE140nnn/GSE140500/suppl/GSE140500%5FBeta%5FTE%2EbyH3K27ac%2Ebed%2Egz | gunzip -c - > GSE140500_Beta_TE.byH3K27ac.bed
wc -l GSE140500_DE_SE.byH3K27ac.bed  # 594
wc -l GSE140500_DE_TE.byH3K27ac.bed  # 5543
bedops --element-of 1 GSE140500_DE_SE.byH3K27ac.bed GSE140500_DE_TE.byH3K27ac.bed  # no overlaps
## make a file named Supp_DE_regions.bed
wc -l Supp_DE_regions.bed  # 6137
bedops --element-of 100% GSE140500_DE_SE.byH3K27ac.bed Supp_DE_regions.bed | wc -l  # 594
bedops --element-of 100% GSE140500_DE_TE.byH3K27ac.bed Supp_DE_regions.bed | wc -l  # 5543
## SE & TE completely overlap the Supplementary Table S4
## Table S4 is the output of ROSE (*_AllEnhancers.table.txt)
## SE stands for Super-Enhancers (*_SuperEnhancers.table.txt)
## TE stands for Typical-Enhancers
wc -l ROSE_DE_SE_original.sorted.bed  # 525
wc -l ROSE_DE_SE_divided_by_2.sorted.bed  # 522
bedops --element-of 100% ROSE_DE_SE_original.sorted.bed ROSE_DE_SE_divided_by_2.sorted.bed | wc -l  # 521
bedops --element-of 100% ROSE_DE_SE_divided_by_2.sorted.bed ROSE_DE_SE_original.sorted.bed | wc -l  # 522
## all SE called by the modified ROSE 100% overlap the regions by original ROSE
## but there are 3 SE called by the original ROSE that do not exist in the other one
## and there is 1 SE called by the original ROSE that has larger region than the corresponding enhancer called by the modified ROSE
bedops --element-of 100% ROSE_DE_SE_divided_by_2.sorted.bed GSE140500_DE_SE.byH3K27ac.bed | wc -l  # 323
bedops --element-of 100% ROSE_DE_SE_original.sorted.bed GSE140500_DE_SE.byH3K27ac.bed | wc -l  # 323
## modifying the script doesn't help at all
## 323 SE called by me 100% overlap the SE reported in the paper
bedops --element-of 100% GSE140500_DE_SE.byH3K27ac.bed ROSE_DE_SE_divided_by_2.sorted.bed | wc -l  # 0
bedops --element-of 100% GSE140500_DE_SE.byH3K27ac.bed ROSE_DE_SE_original.sorted.bed | wc -l  # 0
## but none of the SE reported in the paper 100% overlaps the SE called by me
## which indicates that the length of SE in the paper are larger than called by me
intersectBed -b ROSE_DE_SE_3.sorted.bed -a GSE140500_DE_SE.byH3K27ac.bed -wao|less
intersectBed -a ../ChIP-seq/Meissner/GSE140500_DE_TE.byH3K27ac.bed -b - -wao | awk '$11!=0{ print $3-$2, $7-$6, $11 }' - | less


# 2.9 visualization
## bamTobigwig
cd /project/NeuralNet/CRC/ChIP-seq/Meissner
mkdir visualization
bamCoverage -p 10 -b DE_H3K27ac.bam -o ./visualization/DE_H3K27ac.bw --normalizeUsing RPKM --extendReads 200
time bamCoverage -p 10 -b DE_WCE.bam -o ./visualization/DE_WCE.bw --normalizeUsing RPKM --extendReads 200
## 5m20.887s
bedGraphToBigWig ./macs2_broad/DE_treat_pileup.bdg hg19.chrom.sizes ./visualization/DE_peaks_treat.broadPeak.bw

## TE.bed
cd /project/NeuralNet/CRC/ROSE/5.rose_DE_narrow.05_broad.05_incltss
awk 'BEGIN{ OFS="\t" } $10==0{ print $2,$3,$4,$1,$9,"." }' DE_peaks_AllEnhancers.table.txt | sort-bed - > DE_peaks_Gateway_TypicalEnhancers.bed
awk 'BEGIN{ OFS="\t" } $9==0{ print $2,$3,$4,$1,$8,"." }' Beta_peaks_AllEnhancers.table.txt | sort-bed - > Beta_peaks_Gateway_TypicalEnhancers.bed
cp Beta_peaks_Gateway_TypicalEnhancers.bed /project/ngsuploads/data/Haas/Jieyi/Beta_TE_narrow.05_broad.05.bed
cp Beta_peaks_Gateway_SuperEnhancers.bed /project/ngsuploads/data/Haas/Jieyi/Beta_TE_narrow.05_broad.05.bed

chmod a+r *
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_H3K27ac.bw
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_WCE.bw
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_SE_narrow.01_broad.01.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_SE_narrow.01_broad.05.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_SE_narrow.05_broad.05.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_TE_narrow.01_broad.01.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_TE_narrow.01_broad.05.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_TE_narrow.05_broad.05.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_SE_narrow.05_broad.05_noNMtss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/DE_TE_narrow.05_broad.05_noNMtss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/GSE140500_DE_SE.byH3K27ac.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/GSE140500_DE_TE.byH3K27ac.bed

# signals
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_H3K27ac.bw
# SE & TE from the paper
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/GSE140500_Beta_SE.byH3K27ac.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/GSE140500_Beta_TE.byH3K27ac.bed
# macs2 peaks
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_peaks_narrow.05_broad.1.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_peaks_narrow.05_broad.5.bed
# SE & TE from recapitulation
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_SE_narrow.05_broad.1_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_TE_narrow.05_broad.1_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_SE_narrow.05_broad.5_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/Beta_TE_narrow.05_broad.5_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/


=============================================
# -------------------- 10.12 --------------------
# 1. recapitulation of Meissner's paper (primary beta cell)



# 2.1 download raw data (only DE, at present)
## download data
### https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE139817
cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
wget https://sra-pub-run-odp.s3.amazonaws.com/sra/SRR10466376/SRR10466376 -O Beta_H3K27ac_rep1_L001
wget https://sra-pub-run-odp.s3.amazonaws.com/sra/SRR10466377/SRR10466377 -O Beta_H3K27ac_rep1_L002

## transform data into fastq file
ls Beta* | while read id;
do
	fastq-dump --split-3 --gzip $id
done

## quality control
ls Beta*.gz | while read id; do (fastqc $id -o ./qc/fastqc/Beta); done
multiqc ./qc/fastqc/Beta -o ./qc/multiqc/Beta

# 2.2 bowtie2 mapping
cd /project/NeuralNet/CRC/ChIP-seq/mapping/bowtie2
# get the reference genome
wget https://hgdownload.soe.ucsc.edu/goldenPath/hg19/bigZips/hg19.fa.gz
gunzip -c hg19.fa.gz > hg19.fa
rm hg19.fa.gz
## using 10 threads and it takes 25 min or so
bowtie2-build --threads 10 hg19.fa hg19_2018

cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
index="/project/NeuralNet/CRC/ChIP-seq/mapping/bowtie2/hg19"
time ls -v *_1.fastq.gz | while read id;
do
	name=${id%_*}
	bowtie2 -q -p 15 -x $index/hg19 -1 $id -2 ${name}_2.fastq.gz \
	-S ${name}.sam \
	> ${name}.log 2>&1
done

# sam2bam
ls *.sam | while read id;
do
	samtools view -@ 10 -hbS $id > ${id%.*}.unsorted.bam
done
rm *.sam

samtools merge -@ 15 Beta*.bam -o Beta_H3K27ac.merged.bam
rm Beta_H3K27ac.merged.bam
sambamba sort -t 10 Beta_H3K27ac.merged.bam -o Beta_H3K27ac.bam

# sort
ls Beta*.bam | while read id;
do
	sambamba sort -t 10 $id -o ${id%%.*}.bam
done
rm *.unsorted.bam

# merge

samtools index -@ 15 Beta_H3K27ac.bam


cd /project/NeuralNet/CRC/ChIP-seq/Meissner/
time macs2 callpeak -t Beta_H3K27ac.bam --name Beta --bdg -q 0.05 --broad --broad-cutoff 0.05 --outdir ./macs2_DE_narrow.05_broad.05 2>./macs2_DE_narrow.05_broad.05/Beta.log  # 14m14.386s

cd /project/NeuralNet/CRC/ChIP-seq/Meissner/macs2_Beta_narrow.05_broad.05
awk 'BEGIN{ FS=OFS="\t" } {print $1,$4,"\t"$2,$3,"\t"$6,"\t"$4}' Beta_peaks.broadPeak > Beta_peaks.broadPeak.gff

ssh gnosiophobie
cd /project/NeuralNet/CRC/ROSE/ROSE_package
parameter="Beta_narrowp.01_broadp.01"
outdir="/project/NeuralNet/CRC/ROSE/6.rose_${parameter}_incltss"
gff="/project/NeuralNet/CRC/ChIP-seq/Meissner/macs2_${parameter}/Beta_peaks.broadPeak.gff"
bam="/project/NeuralNet/CRC/ChIP-seq/Meissner/Beta_H3K27ac.bam"
base=$(basename $bam)
# time python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 0 >$outdir/${base%_*}.log &
mxqsub --group-name="rose_main" --processors=10 --memory=10G --runtime=5h --stdout="$outdir/${base%_*}.log" python2 ROSE_main.py -g HG19_NR -i $gff -r $bam -o $outdir -s 12500 -t 2000 &

sed '1i track name="Beta_ROSE_SE_narrowp.01_broadp.05_exclNRtss" description="Beta SE called by ROSE with --narrow-p=0.01 and --broad-p=0.05, excluding all NR tss" color=255,0,0' ../3.2.rose_Beta_narrowp.01_broadp.05_exclNRtss/Beta_peaks_Gateway_SuperEnhancers.bed > /project/ngsuploads/data/Haas/Jieyi/Beta_SE_narrowp.01_broadp.05_exclNRtss.bed
awk 'BEGIN{ OFS="\t" } $9==0{ print $2,$3,$4,$1,$8,"." }' ../3.2.rose_Beta_narrowp.01_broadp.05_exclNRtss/Beta_peaks_AllEnhancers.table.txt | sed '1i track name="Beta_ROSE_TE_narrowp.01_broadp.05_exclNRtss" description="Beta TE called by ROSE with --narrow-p=0.01 and --broad-p=0.05, excluding all NR tss" color=128,128,128' > /project/ngsuploads/data/Haas/Jieyi/Beta_TE_narrowp.01_broadp.05_exclNRtss.bed
chmod a+r /project/ngsuploads/data/Haas/Jieyi/*


parameter="Beta_narrow.05_broad.1"
cutoff=500
annotation="HG19_NM"
outdir="/project/NeuralNet/CRC/CRCmapper/2-2.crc_${parameter}_incltss_cutoff${cutoff}/"
enhTable="/project/NeuralNet/CRC/ROSE/2.rose_${parameter}_incltss/Beta_peaks_AllEnhancers.table.txt"
bed="/project/NeuralNet/CRC/ChIP-seq/Meissner/macs2_${parameter}/Beta_peaks.broadPeak"
bam="/project/NeuralNet/CRC/ChIP-seq/Meissner/Beta_H3K27ac.bam"
base=$(basename $bam)
genome="../hg19/"
mxqsub --group-name="crc" --processors=10 --memory=20G --runtime=5h --stdout="$outdir${base%_*}.log" python2 CRCmapper.py -e $enhTable -b $bam -g $annotation -f $genome -s $bed -n Beta -o $outdir -E $cutoff &





# 3. CRUP -> ROSE -> CRCmapper
# 3.1 ROSE
## In order to successfully run ROSE, all bam files must have chromosome IDs starting with chr
## ref: https://josephcckuo.wordpress.com/2016/11/17/modify-chromosome-notation-in-bam-file/
# modify chr annotations
cd /project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam
samtools view -h H3K27ac_HI-32.bam | sed -e '/^@SQ/s/SN\:/SN\:chr/' -e '/^[^@]/s/\t/\tchr/2' | samtools view -bS - > H3K27ac_HI-32.chr.unsorted.bam &
samtools view -h H3K4me1_HI-32.bam | sed -e '/^@SQ/s/SN\:/SN\:chr/' -e '/^[^@]/s/\t/\tchr/2' | samtools view -bS - > H3K4me1_HI-32.chr.unsorted.bam &
samtools view -h H3K4me3_HI-32.bam | sed -e '/^@SQ/s/SN\:/SN\:chr/' -e '/^[^@]/s/\t/\tchr/2' | samtools view -bS - > H3K4me3_HI-32.chr.unsorted.bam &
# sort
ls *unsorted.bam | while read id;
do
	echo $id, ${id%%.*}
	sambamba sort -t 10 $id -o ${id%%.*}.chr.bam
	rm $id
done
# index
ls *chr.bam | while read id;
do
	echo $id
	samtools index -@ 10 $id
done
# generate gff file
cd /project/NeuralNet/CRC/crup
awk 'BEGIN{ FS=OFS="\t" } { print "chr"$1,"CRUP_peak_"NR,"\t"$2,$3,"\t.","\tCRUP_peak_"NR }' islets.HI-32.CRUP.singleEnh.bedGraph > islets.HI-32.CRUP.singleEnh.gff
# ROSE main
cd /project/NeuralNet/CRC/ROSE/ROSE_package
mkdir ../1-1.rose_HI-32_K27ac_incltss
outdir="/project/NeuralNet/CRC/ROSE/1-1.rose_HI-32_K27ac_incltss/"
gff="/project/NeuralNet/CRC/crup/islets.HI-32.CRUP.singleEnh.gff"
bam="/project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam/H3K27ac_HI-32.chr.bam"
base=$(basename $bam)
# time python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 0 >$outdir/${base%_*}.log &
mxqsub --group-name="rose_main" --processors=10 --memory=10G --runtime=5h --stdout="$outdir${base%%.*}.log" python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 0 &

mkdir ../1-2.rose_HI-32_K4me1_incltss
outdir="/project/NeuralNet/CRC/ROSE/1-2.rose_HI-32_K4me1_incltss/"
bam="/project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam/H3K4me1_HI-32.chr.bam"
base=$(basename $bam)
mxqsub --group-name="rose_main" --processors=10 --memory=10G --runtime=5h --stdout="$outdir${base%%.*}.log" python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 0 &

outdir="/project/NeuralNet/CRC/ROSE/1-3.rose_HI-32_K4me3_incltss/"
bam="/project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam/H3K4me3_HI-32.chr.bam"
base=$(basename $bam)
mxqsub --group-name="rose_main" --processors=10 --memory=10G --runtime=5h --stdout="$outdir${base%%.*}.log" python2 ROSE_main.py -g HG19 -i $gff -r $bam -o $outdir -s 12500 -t 0 &

# CRCmapper
cd /project/NeuralNet/CRC/CRCmapper/CRCmapper_package
mkdir ../1-1.crc_HI-32_K27ac_incltss
mkdir ../1-2.crc_HI-32_K4me1_incltss
mkdir ../1-3.crc_HI-32_K4me3_incltss

awk 'BEGIN{ FS=OFS="\t" } { print "chr"$1,$2,$3,"CRUP_peak_"NR,$4,"." }' islets.HI-32.CRUP.singleEnh.bedGraph > islets.HI-32.CRUP.singleEnh.bed

parameter="HI-32_K27ac_incltss"
# cutoff=500
annotation="HG19_NM"
outdir="/project/NeuralNet/CRC/CRCmapper/1-1.crc_${parameter}/"
enhTable="/project/NeuralNet/CRC/ROSE/1-1.rose_${parameter}/islets_AllEnhancers.table.txt"
bed="/project/NeuralNet/CRC/crup/islets.HI-32.CRUP.singleEnh.bed"
bam="/project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam/H3K27ac_HI-32.chr.bam"
base=$(basename $bam)
genome="../hg19/"
mxqsub --group-name="crc" --processors=10 --memory=20G --runtime=5h --stdout="$outdir${base%%.*}.log" python2 CRCmapper.py -e $enhTable -b $bam -g $annotation -f $genome -s $bed -n ${base%%.*} -o $outdir &

parameter="HI-32_K4me1_incltss"
outdir="/project/NeuralNet/CRC/CRCmapper/1-2.crc_${parameter}/"
enhTable="/project/NeuralNet/CRC/ROSE/1-2.rose_${parameter}/islets_AllEnhancers.table.txt"
bam="/project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam/H3K4me1_HI-32.chr.bam"
base=$(basename $bam)
mxqsub --group-name="crc" --processors=10 --memory=20G --runtime=5h --stdout="$outdir${base%%.*}.log" python2 CRCmapper.py -e $enhTable -b $bam -g $annotation -f $genome -s $bed -n ${base%%.*} -o $outdir &

parameter="HI-32_K4me3_incltss"
outdir="/project/NeuralNet/CRC/CRCmapper/1-3.crc_${parameter}/"
enhTable="/project/NeuralNet/CRC/ROSE/1-3.rose_${parameter}/islets_AllEnhancers.table.txt"
bam="/project/NeuralNet/CRC/ChIP-seq/mapping/STAR/rmdup_bam/H3K4me3_HI-32.chr.bam"
base=$(basename $bam)
mxqsub --group-name="crc" --processors=10 --memory=20G --runtime=5h --stdout="$outdir${base%%.*}.log" python2 CRCmapper.py -e $enhTable -b $bam -g $annotation -f $genome -s $bed -n ${base%%.*} -o $outdir &

# visualization
cd /project/ngsuploads/data/Haas/Jieyi
# peaks
sed "1i track name='CRUP_peaks_HI-32' description='islets.HI-32.CRUP.singleEnh.bedGraph'" /project/NeuralNet/CRC/crup/islets.HI-32.CRUP.singleEnh.bed > CRUP_peaks_HI-32.bed
# SE
mod="K27ac"
sed "1i track name='SE_HI-32_${mod}_incltss' description='SE called by ROSE using H3${mod} of sample HI-32, including all tss' color=255,0,0" /project/NeuralNet/CRC/ROSE/1-1.rose_HI-32_${mod}_incltss/islets_Gateway_SuperEnhancers.bed > CRUP_SE_HI-32_${mod}_incltss.bed
# TE
awk 'BEGIN{ OFS="\t" } $9==0{ print $2,$3,$4,$1,$8,"." }' /project/NeuralNet/CRC/ROSE/1-1.rose_HI-32_${mod}_incltss/islets_AllEnhancers.table.txt | sed "1i track name='TE_HI-32_${mod}_incltss' description='TE called by ROSE using H3${mod} of sample HI-32, including all tss' color=128,128,128" > CRUP_TE_HI-32_${mod}_incltss.bed

chmod a+r /project/ngsuploads/data/Haas/Jieyi/*

http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_SE_HI-32_K27ac_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_SE_HI-32_K4me1_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_SE_HI-32_K4me3_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_TE_HI-32_K27ac_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_TE_HI-32_K4me1_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_TE_HI-32_K4me3_incltss.bed
http://ngs.molgen.mpg.de/ngsuploads/Haas/Jieyi/CRUP_peaks_HI-32.bed



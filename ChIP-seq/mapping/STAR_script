# --- quality control
fastqc ./fastq/HM/H3K4me3_HI-21.fq.gz -o ./fastqc/HM/

(base) jieyidi@gnosiophobie:/project/NeuralNet/CRC/ChIP-seq>
ls ./fastq/HM/*.gz | while read id; do (fastqc $id -o ./fastqc/HM/); done
multiqc ./fastqc/HM/ -o ./multiqc/HM/


# --- mapping ---
# loop: without nohup &, setting from the paper, define the file name
star_version="/project/ngsvin/bin/mapping/STAR/STAR_2.6.1d/bin/Linux_x86_64/STAR"
ls ./fastq/HM/*.gz | while read id;
do
	file=${id##*/}  # select the part after the last slash
	# e.g. fastq/HM/H3K4me1_HI-21.fq.gz -> H3K4me1_HI-21.fq.gz
	sample=${file%%.*}  # select the part before the first dot
	# e.g. H3K4me1_HI-21.fq.gz -> H3K4me1_HI-21
	${star_version} --runThreadN 10 \
	--genomeDir /project/ngsvin/MappingIndices/STAR/hg19 \
	--readFilesIn ${id} \
	--readFilesCommand zcat \
	--alignEndsType EndToEnd \
	--alignIntronMax 1 \
	--alignSJDBoverhangMin 999 \
	--outTmpDir /scratch/local2/jieyidi/STAR \
	--outSAMtype BAM Unsorted \
	--outStd BAM_Unsorted \
	--outSAMmultNmax 1 \
	--outFilterMultimapNmax 1 \
	--outFilterMismatchNmax 1 \
	--outFileNamePrefix ./mapping/STAR/unsorted_bam_logs/${sample}_ \
	> ./mapping/STAR/unsorted_bam/${sample}.bam
done

# for single file: without nohup &, setting from the paper, define the file name
${star_version} --runThreadN 10 \
--genomeDir /project/ngsvin/MappingIndices/STAR/hg19 \
--readFilesIn ./fastq/HM/H3K27ac_HI-45.fq.gz \
--readFilesCommand zcat \
--alignEndsType EndToEnd \
--alignIntronMax 1 \
--alignSJDBoverhangMin 999 \
--outTmpDir /scratch/local2/jieyidi/STAR \
--outSAMtype BAM Unsorted \
--outStd BAM_Unsorted \
--outSAMmultNmax 1 \
--outFilterMultimapNmax 1 \
--outFilterMismatchNmax 1 \
--outFileNamePrefix ./mapping/STAR_logs_test/H3K27ac_HI-45_ \
> ./mapping/STAR_test/H3K27ac_HI-45.bam


# --- sort ---
ls ./mapping/STAR/unsorted_bam/*.bam | while read id;
do
	sample=$(basename $id)
	# sample=$(basename $id ".bam")
	samtools sort -@ 10 $id -o ./mapping/STAR/sorted_bam/$sample
done

# --- build index ---
ls ./mapping/STAR/sorted_bam/*.bam | while read id;
do
	samtools index -@ 10 $id
done

# --- remove duplicates ---
tmp_dir="/scratch/local2/jieyidi/"
ls ./mapping/STAR/sorted_bam/*.bam | while read id;
do
	sambamba markdup -r -t 10 --overflow-list-size 600000 --tmpdir $tmp_dir $id ./mapping/STAR/rmdup_bam/$(basename $id)
done


# bam file qc
ls -tr ./mapping/STAR/*.bam | while read id; do (nohup samtools flagstat -@)



wget http://hgdownload.cse.ucsc.edu/goldenpath/hg19/bigZips/latest/hg19.fa.gz
gunzip -c hg19.fa.gz > hg19.fa